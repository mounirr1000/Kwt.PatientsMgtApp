@using Kwt.PatientsMgtApp.WebUI.Infrastructure
@model Kwt.PatientsMgtApp.Core.Models.PatientModel

@{
    ViewBag.Title = "Patient Details";
}

<div class="mt-3">
    <p>
        <a href="@Url.Action("Index")" class="k-button"><i class="fa fa-arrow-left" style="color: lightblue"></i> Back to List</a>
        @if (User.IsInAnyRoles(CrudRoles.PatientUpdateRoles))
        {
            <a href="@Url.Action("Edit", new {patientCid = Model.PatientCID})" class="k-button"><i class="fa fa-pencil" style="color: blueviolet"></i> Edit</a>

        }
        @if (User.IsInAnyRoles(CrudRoles.PatientCrudRoles))
        {
            @* Uncomment the next lines once the invoice is complete *@
            <div class="pt-3 pb-3 col-md-3">
                <a href="@Url.Action("GetPatientFolders", "Patient", new { patientCid = Model.PatientCID, patientName=Model.PatientFName+" "+Model.PatientMName+" "+Model.PatientLName })" class="k-button"><i class="fa fa-file-pdf-o" style="color:lightcoral"></i> Patient Files</a>
            </div>
        }
    </p>
</div>
<div class="loader"></div>
<div id="contentPatientDetail" style="visibility: hidden;">
    <button data-target="#panelbarPatient" data-toggle="collapse"><i></i> Patient Information</button>

    <fieldset id="panelbarPatient" class="collapse show">

        <ul class="fieldlist form-row">
            <li class="col-md-3">
                @Html.LabelFor(model => model.PatientCID, new { @class = "" })
                @Html.TextBoxFor(model => model.PatientCID, new { @class = "k-textbox edit", style = "width: 100%;", @readonly = "readonly" })
            </li>

            <li class="col-md-8">
                @Html.LabelFor(model => model.PatientPasportFile, new { @class = "" })
                @if (Model.PatientFiles[0].FilesPath.Length > 0)
                {
                    <label style="width: 100%; display:block">
                        @for (int x = 0; x < @Model.PatientFiles[0].FilesPath.Length; x++)
                        {
                            <a style="width: 100%;" href="@Url.Action("Download", "Patient",  new { link = @Model.PatientFiles[0].FilesPath[x], filename=@Model.PatientFiles[0].FilesName[x]})">@Model.PatientFiles[0].FilesName[x]</a>
                            <span>|</span>
                        }
                    </label>
                }
                else
                {
                    <label> No files found</label>
                }
            </li>

            <li class="col-md-3">
                @Html.LabelFor(model => model.Name, new { @class = "" })
                @Html.TextBoxFor(model => model.Name, new { @class = "k-textbox edit", style = "width: 100%;", @readonly = "readonly" })
            </li>
            @*<li class="col-md-3">
                        @Html.LabelFor(model => model.KWTPhone, new { @class = "" })
                        @Html.TextBoxFor(model => model.KWTPhone, new { @class = "k-textbox edit", style = "width: 100%;", @readonly = "readonly" })
                </li>*@
            <li class="col-md-3">
                @Html.LabelFor(model => model.USPhone, new { @class = "" })
                @Html.TextBoxFor(model => model.USPhone, new { @class = "k-textbox edit", style = "width: 100%;", @readonly = "readonly" })
            </li>

            <li class="col-md-3">
                @Html.LabelFor(model => model.FirstApptDAte, new { @class = "" })
                @Html.TextBoxFor(model => model.FirstApptDAteFormatted, new { @class = "k-textbox edit", style = "width: 100%;", @readonly = "readonly" })
            </li>

            <li class="col-md-3">
                @Html.LabelFor(model => model.EndTreatDate, new { @class = "" })
                @Html.TextBoxFor(model => model.EndTreatDateFormatted, new { @class = "k-textbox edit", style = "width: 100%;", @readonly = "readonly" })
            </li>
            <li class="col-md-8">
                @Html.LabelFor(model => model.PatientFirstApointmentFile, new { @class = "" })
                @if (Model.PatientFiles[1].FilesPath.Length > 0)
                {
                    <label style="width: 100%; display:block">
                        @for (int x = 0; x < @Model.PatientFiles[1].FilesPath.Length; x++)
                        {
                            <a href="@Url.Action("Download", "Patient",  new { link = @Model.PatientFiles[1].FilesPath[x], filename=@Model.PatientFiles[1].FilesName[x]} )">@Model.PatientFiles[1].FilesName[x]</a>
                            <span>|</span>
                        }
                    </label>
                }
                else
                {
                    <label> No files found</label>
                }
            </li>
            <li class="col-md-3">
                @Html.LabelFor(model => model.IsActive, new { @class = "" })
                @Html.TextBoxFor(model => model.IsActive, new { @class = "k-textbox edit", style = "width: 100%;", @readonly = "readonly" })
            </li>

            <li class="col-md-6">
                @Html.LabelFor(model => model.Hospital, new { @class = "" })
                @Html.TextBoxFor(model => model.Hospital, new { @class = "k-textbox edit", style = "width: 100%;", @readonly = "readonly" })
            </li>
            <li class="col-md-3">
                @Html.LabelFor(model => model.Doctor, new { @class = "" })
                @Html.TextBoxFor(model => model.Doctor, new { @class = "k-textbox edit", style = "width: 100%;", @readonly = "readonly" })
            </li>
            <li class="col-md-6">
                @Html.LabelFor(model => model.Specialty, new { @class = "" })
                @Html.TextBoxFor(model => model.Specialty, new { @class = "k-textbox edit", style = "width: 100%;", @readonly = "readonly" })
            </li>
            <li class="col-md-6">
                @Html.LabelFor(model => model.Diagnosis, new { @class = "" })
                @Html.TextAreaFor(model => model.Diagnosis, new { @class = "k-textbox edit", style = "width: 100%;", @readonly = "readonly" })
            </li>
            <li class="col-md-3">
                @Html.LabelFor(model => model.Agency, new { @class = "" })
                @Html.TextBoxFor(model => model.Agency, new { @class = "k-textbox edit", style = "width: 100%;", @readonly = "readonly" })
            </li>


        </ul>

    </fieldset>
    <button data-target="#panelbarCompanion" data-toggle="collapse"><i></i> Companions Information</button>
    <fieldset id="panelbarCompanion" class="collapse">
        <ul class="fieldlist form-row">
            @foreach (var companion in Model.Companions.Where(c => c.CompanionType == "Primary"))
            {
                if (Model.Companions.Any(c => c.CompanionType == "Primary"))
                {

                    <li class="col-md-3">
                        @Html.LabelFor(model => companion.CompanionCID, new { @class = "" })
                        <a href='@Url.Action("Details", "Companion")?CompanionCid=@companion.CompanionCID&PatientCid=@Model.PatientCID' class="k-textbox edit" style="width: 100%;">@companion.CompanionCID</a>
                    </li>
                    <li class="col-md-3">
                        @Html.LabelFor(model => companion.Name, new { @class = "" })
                        @Html.TextBoxFor(model => companion.Name, new { @class = "k-textbox edit", style = "width: 100%;", @readonly = "readonly" })
                    </li>
                    if (companion.IsActive)
                    {
                        <li class="col-md-3">
                            @Html.LabelFor(model => companion.IsActive, new { @class = "" })
                            <span style="color: yellowgreen; cursor:default" class="k-textbox edit" readonly="readonly"> Active</span>
                        </li>
                    }
                    else
                    {
                        <li class="col-md-3">
                            @Html.LabelFor(model => companion.IsActive, new { @class = "" })
                            <span style="color: lightcoral; cursor:default" class="k-textbox edit" readonly="readonly"> Not Active</span>
                        </li>
                    }
                    if (companion.IsBeneficiary)
                    {
                        <li class="col-md-3">
                            @Html.LabelFor(model => companion.IsBeneficiary, new { @class = "" })
                            <span style="color: yellowgreen; cursor:default;" class="k-textbox edit" readonly="readonly"> Beneficiary</span>
                        </li>
                    }
                    else
                    {
                        <li class="col-md-3">
                            @Html.LabelFor(model => companion.IsBeneficiary, new { @class = "" })
                            <span style="color: lightcoral; cursor:default;" class="k-textbox edit" readonly="readonly"> Not Beneficiary</span>
                        </li>
                    }
                    <li class="col-md-3">
                        @Html.LabelFor(model => companion.DateIn, new { @class = "" })
                        @Html.TextBoxFor(model => companion.DateInFormatted, new { @class = "k-textbox edit", style = "width: 100%;", @readonly = "readonly" })
                    </li>
                    <li class="col-md-3">
                        @Html.LabelFor(model => companion.DateOut, new { @class = "" })
                        @Html.TextBoxFor(model => companion.DateOutFormatted, new { @class = "k-textbox edit", style = "width: 100%;", @readonly = "readonly" })
                    </li>
                    <li class="col-md-3">
                        @Html.LabelFor(model => companion.Notes, new { @class = "" })
                        @Html.TextAreaFor(model => companion.Notes, new { @class = "k-textbox edit", style = "width: 100%;", @readonly = "readonly" })
                    </li>
                }
                else
                {
                    <li class="col-md-6">
                        No primary companion found in our records for this patient
                    </li>

                }
            }


        </ul>



        <h3>Secondary Companions Information</h3>
        <ul>

            @if (Model.Companions.Any(c => c.CompanionType != "Primary"))
            {
                <li>
                    <table id="patientSecondaryCompanionInfo">

                        <thead>
                            <tr>
                                <th>
                                    Companion CID
                                </th>
                                <th>
                                    Name
                                </th>
                                <th>
                                    Status
                                </th>
                                <th>
                                    Is Beneficiary
                                </th>
                                <th>
                                    Date In
                                </th>
                                <th>
                                    Date Out
                                </th>
                                <th>
                                    Notes
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var companion in Model.Companions.Where(c => c.CompanionType != "Primary"))
                            {
                                <tr>
                                    <td>
                                        @companion.CompanionCID
                                    </td>
                                    <td>
                                        @companion.Name
                                    </td>
                                    <td>

                                        @if (companion.IsActive)
                                        {
                                            <span style="color: yellowgreen"> Active</span>
                                        }
                                        else
                                        {
                                            <span style="color: lightcoral"> Not Active</span>
                                        }
                                    </td>
                                    <td>
                                        @if (companion.IsBeneficiary)
                                        {
                                            <span style="color: yellowgreen"> Beneficiary</span>
                                        }
                                        else
                                        {
                                            <span style="color: lightcoral"> Not Beneficiary</span>
                                        }
                                    </td>
                                    <td>
                                        @companion.DateInFormatted
                                    </td>
                                    <td>
                                        @companion.DateOutFormatted
                                    </td>
                                    <td>
                                        @companion.Notes
                                    </td>
                                </tr>
                            }
                        </tbody>

                    </table>
                </li>
            }
            else
            {
                <li>
                    No Secondary companion found in our records for this patient
                </li>

            }

        </ul>


    </fieldset>
    @if (User.IsInAnyRoles(CrudRoles.PaymentCrudRoles))
    {
        <button data-target="#panelbarPayment" data-toggle="collapse"><i></i> Payments Information</button>
        <fieldset id="panelbarPayment" class="collapse">
            <legend></legend>
            <h3>Payments Information</h3>
            <ul>
                @if (Model.Payments.Any())
                {
                    <li>
                        <div id="patientPaymentInfo"></div>
                    </li>
                }
                else
                {
                    <li>
                        <span>No payment found in our records for this patient</span>
                    </li>

                }

            </ul>


        </fieldset>
    }
    <button data-target="#panelbarPatientHistory" data-toggle="collapse"><i></i> Record History</button>
    <fieldset id="panelbarPatientHistory" class="collapse">
        <legend></legend>
        <h3>Patient History</h3>
        @if (Model.PatientHistories.Any())
            {
            <ul>
                <li>
                    <table id="patientHistoryInfo">

                        <thead>
                            <tr>
                                <th>
                                    Patient CID
                                </th>
                                <th>
                                    Name
                                </th>
                                <th>
                                    Hospital
                                </th>
                                <th>
                                    Doctor
                                </th>

                                <th>
                                    Date In
                                </th>
                                <th>
                                    Date Out
                                </th>
                                <th>
                                    Notes
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var patient in Model.PatientHistories)
                            {
                                <tr>
                                    <td>
                                        @patient.PatientCID
                                    </td>
                                    <td>
                                        @patient.PatientFName
                                    </td>
                                    <td>
                                        @patient.Hospital
                                    </td>
                                    <td>
                                        @patient.Doctor
                                    </td>
                                    <td>
                                        @patient.FirstApptDateFormatted
                                    </td>
                                    <td>
                                        @patient.EndTreatDateFormatted
                                    </td>

                                    <td>
                                        @patient.Notes
                                    </td>

                                </tr>
                            }
                        </tbody>

                    </table>
                </li>
            </ul>

        }
        else
        {
            <ul>
                <li>
                    <span>No patient history found in our records for this patient</span>
                </li>
            </ul>

        }


        <h3>Companions History</h3>
        @if (Model.CompanionHistories.Any())
            {
            <ul>
                <li>
                    <table id="patientCompanionHistoryInfo">

                        <thead>
                            <tr>
                                <th>
                                    Companion CID
                                </th>
                                <th>
                                    Name
                                </th>
                                <th>
                                    Status
                                </th>
                                <th>
                                    Beneficiary?
                                </th>
                                <th>
                                    Date In
                                </th>
                                <th>
                                    Date Out
                                </th>
                                <th>
                                    Comapnion Type
                                </th>
                                <th>
                                    Notes
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var companion in Model.CompanionHistories)
                            {
                                <tr>
                                    <td>
                                        @companion.CompanionCID
                                    </td>
                                    <td>
                                        @companion.Name
                                    </td>
                                    <td>
                                        @if (companion.IsActive == true)
                                        {
                                            <span style="color: yellowgreen"> Active</span>
                                        }
                                        else
                                        {
                                            <span style="color: lightcoral"> Not Active</span>
                                        }
                                    </td>
                                    <td>
                                        @if (companion.IsBeneficiary == true)
                                        {
                                            <span style="color: yellowgreen"> Beneficiary</span>
                                        }
                                        else
                                        {
                                            <span style="color: lightcoral"> Not Beneficiary</span>
                                        }
                                    </td>
                                    <td>
                                        @companion.DateInFormatted
                                    </td>
                                    <td>
                                        @companion.DateOutFormatted
                                    </td>
                                    <td>
                                        @companion.CompanionType
                                    </td>
                                    <td>
                                        @companion.Notes
                                    </td>

                                </tr>
                            }
                        </tbody>

                    </table>
                </li>
            </ul>

        }
        else
        {
            <ul>
                <li>
                    <span>No companion history found in our records for this patient</span>
                </li>
            </ul>

        }

    </fieldset>

</div>
@section Scripts{
    <script type="text/javascript">

        $('document').ready(function () {
            $("#contentPatientDetail").css("visibility", "visible");
            var patient = @Html.Raw(Json.Encode(Model));
            console.log("patient>=",patient);
            $('#contentPatientDetail button').addClass('btn btn-block mb-2 text-uppercase text-white bg-info');
            //fa fa-angle-double-down pull-left
            $('#contentPatientDetail button i').addClass('fa fa-angle-double-down pull-left');


            $('#contentPatientDetail button').click(function (e) {
                e.preventDefault();
                var $this = this;
                var caret = $($this).find('i');
                if ($(caret).hasClass('fa-angle-double-down'))
                    $(caret).removeClass('fa-angle-double-down').addClass("fa-angle-double-up");
                else
                    $(caret).removeClass('fa-angle-double-up').addClass("fa-angle-double-down");

            });

            $("#panelbarPatient").kendoPanelBar();
            $("#panelbarCompanion").kendoPanelBar();
            $("#panelbarPayment").kendoPanelBar();
            $("#panelbarPatientHistory").kendoPanelBar();





            $("#patientCompanionInfo, #patientSecondaryCompanionInfo").kendoGrid({
                height: 350,
                scrollable: {
                    virtual: true
                },
                pageable: {
                    refresh: true,
                    pageSizes: true,
                    buttonCount: 5,

                },
                serverPaging: true,
                pageSize: 1,

                //groupable: true,
                //sortable: true
            });
            var payments = @Html.Raw(Json.Encode(Model.Payments));
            console.log(payments);
            $("#patientPaymentInfo").kendoGrid({
                //height: 350,
                scrollable: {
                    virtual: true
                },
                sortable: true,
                resizable: true,
                pageable: {
                    refresh: true,
                    pageSizes: true,
                    buttonCount: 5,

                },
                serverPaging: true,
                pageSize: 1,
                columns: [
                    {
                        field: "PaymentID",
                        title: "Voucher#",
                    },
                    {
                        field: "PatientCID",
                        title: "Patient CID"
                    },
                    {
                        field: "BeneficiaryCID",
                        title: "Beneficiary CID"
                    },
                    {
                        field: "BeneficiaryFullName",
                        title: "Beneficiary Name"
                    },
                    {
                        field: "PaymentDateFormatted",
                        title: "Payment Date"
                    },
                    {
                        field: "PaymentStartDateFormatted",
                        title: "Start Date",

                    },
                    {
                        field: "PaymentEndDateFormatted",
                        title: "End Date",

                    },
                    {
                        field: "PaymentDeductionObject.TotalDeduction",
                        title: "Deducted Amount",
                        template: "#if(PaymentDeductionObject!=null){# #: PaymentDeductionObject.TotalDeduction # #}else{##: 0 ##}#"
                    },
                    {
                        field: "PaymentDeductionObject.FinalAmount",
                        title: "Final Amount",
                        template: "#if(PaymentDeductionObject!=null){# #: PaymentDeductionObject.FinalAmount # #}else{##: TotalDue ##}#"
                    }


                ],
                dataSource: {
                    data: payments
                }
            });
            $("#patientHistoryInfo").kendoGrid({
                //height: 350,
                scrollable: {
                    virtual: true
                },
                pageable: {
                    refresh: true,
                    pageSizes: true,
                    buttonCount: 5,

                },
                serverPaging: true,
                pageSize: 3
                //groupable: true,
                //sortable: true
            });
            $("#patientCompanionHistoryInfo").kendoGrid({
                //height: 350,
                scrollable: {
                    virtual: true
                },
                pageable: {
                    refresh: true,
                    pageSizes: true,
                    buttonCount: 5,

                },
                serverPaging: true,
                pageSize: 1
                //groupable: true,
                //sortable: true
            });
            $("#panelbarPatient").kendoPanelBar();
            $(".loader").css("display", "none");
        });
    </script>
}
